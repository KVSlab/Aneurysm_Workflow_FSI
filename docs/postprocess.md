(overview:post)=

# Post-processing

After the FSI simulations, the last step of `VaSP` is post-processing the results.  
The `src/vasp/automatedPostprocessing` directory is organized into several sub-packages and modules, each dedicated to different aspects of postprocessing for the `VaSP` project.  
The primary focus is on handling mesh data (`postprocessing_mesh`), postprocessing using FEniCS (`postprocessing_fenics`), and postprocessing with HDF5 files (`postprocessing_h5py`). Here’s an outline of the structure:

```
src/
└── vasp/
    └── automatedPostprocessing/
        ├── __init__.py
        ├── log_plotter.py
        ├── postprocessing_common.py
        ├── predeform_mesh.py
        |
        ├── postprocessing_mesh/
        │   ├── __init__.py
        │   ├── create_refined_mesh.py
        │   ├── postprocessing_mesh_common.py
        │   └── separate_mesh.py
        |
        ├── postprocessing_fenics/
        │   ├── __init__.py
        │   ├── compute_hemodynamics.py
        │   ├── compute_stress_strain.py
        │   ├── create_hdf5.py
        │   ├── create_separate_domain_visualization.py
        │   └── postprocessing_fenics_common.py
        |
        └── postprocessing_h5py/
            ├── __init__.py
            ├── chroma_filters.py
            ├── create_hi_pass_viz.py
            ├── create_spectrograms_chromagrams.py
            ├── create_spectrum.py
            ├── postprocessing_common_h5py.py
            └── spectrograms.py
```

In the following, we will give an overview and explanations for each scripts.

## **Top-Level Directory: `automatedPostprocessing`**

   - **General Utilities**: Contains general utility scripts `log_plotter.py`, `predeform_mesh.py`, and `postprocessing_common.py`.  

   - `log_plotter.py` - The usage is explained [here](simulation:log_plotter). This is to extract information from a log file generated during the run, and is particularly useful when running FSI simulations on the cluster.  

   - `predeform_mesh.py` - This is used to pre-deform the mesh prior to running pulsatile FSI. It is assumed that pre-deformation simulation has been already performed.  
   This script is available as a following command:
   ```console
    vasp-predeform-mesh --folder /path/to/your/result --scale-factor -1
   ```

## **postprocessing_mesh**
   - **Purpose**: Focuses on handling mesh data used in simulations for later post-processing purposes.
   - `create_refined_mesh.py` - In `turtleFSI`, there is a way to save visualization file with refined mesh via `save-deg` parameter. To utilize such a functionality in the other parts of the post-processing, it is necessary to create a stand-alone refined mesh. This script is dedicated for that and can be run as follows:
   ```console
   vasp-refine-mesh --folder /path/to/your/result
   ```
   Normally, `vasp-refine-mesh` will find the original (non-refined) mesh automatically, but the user can specify the path to the mesh using `--mesh-path` as a command-line argument.  
   As a result, the user should get a HDF5 file named `mesh_refined.h5` under `Mesh` folder in your result folder.  
   The following image is an example of original and refined mesh.

   ```{figure} figures/refined_mesh.png
   ---
   name: refined_mesh
   ---
   An example of refined mesh generated by `vasp-refine-mesh` function
   ```

   - `separate-mesh.py` - By default, `turtleFSI` shows visualizations with a whole domain (fluid + solid). However, it is convenient to visualize the results for fluid and solid separately. Furthermore, we will utilize those separated meshes for computing variables that are only relevant for each domains, such as stresses inside the solid.  
   To generate separated meshes, please run
   ```console
   vasp-separate-mesh --folder /path/to/your/result
   ```

   Same as `vasp-refine-mesh`, `VaSP` will automatically find a mesh and will generate separate meshes for both original and refined mesh. Therefore, after running both `vasp-refine-mesh` and `vasp-separate-mesh`, `Mesh` folder inside your result folder should look like this:
   ```
   Mesh/
   ├── mesh.h5
   ├── mesh_fluid.h5
   ├── mesh_solid.h5
   ├── mesh_refined.h5
   ├── mesh_refined_fluid.h5
   └── mesh_refined_solid.h5
   ``` 
   The following image shows an example of separated fluid and solid domain with refined mesh.

   ```{figure} figures/separate_mesh.png
   ---
   name: separate_mesh
   ---
   An example of fluid and solid mesh generated by `vasp-separate-mesh` function
   ```


## **postprocessing_fenics**
   - **Purpose**: Dedicated to postprocessing tasks related to the FEniCS project, which is used for solving partial differential equations.
   - **Contents**: Contains scripts for computing hemodynamics, stress and strain metrics, creating HDF5 files, visualizing separate domains, and common FEniCS postprocessing utilities.

## **postprocessing_h5py**
   - **Purpose**: Focuses on postprocessing tasks involving HDF5 files, utilizing the `h5py` library.
   - **Contents**: Includes scripts for creating spectrograms, chromagrams, high-pass visualizations, spectra, and applying chroma filters, along with common H5PY-related postprocessing utilities.
